name: jopau-react/utils release

on:
  push:
    tags:
      - '@jopau-react/utils@*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'
          registry-url: 'https://registry.npmjs.org'
          scope: '@jopau-react'
      - name: Install dependencies
        run: yarn install
      - name: Build
        run: |
          cd packages/utils
          yarn run build
      - name: Check Package Version
        uses: PostHog/check-package-version@v2
        id: cpv
        with:
          path: packages/utils
      - name: Publish package to NPM ðŸ“¦
        if: steps.cpv.outputs.is-new-version == 'true'
        run: |
          cd packages/utils          
          cp package.json ./dist && cp README.md ./dist
          npm publish ./dist --access public
          echo "Package published successfully ðŸŽ‰"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    needs: [publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_TOKEN }}
