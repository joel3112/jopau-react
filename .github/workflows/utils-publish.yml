name: jopau-react/utils publish

on:
  push:
    paths:
      - 'packages/utils/**'
      - '.github/workflows/utils.yml'
    branches:
      - main
    tags-ignore:
      - 'v*'

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  call-workflow:
    uses: ./.github/workflows/reusable.yml
    with:
      package: utils

  publish:
    needs: call-workflow
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ⬇️ Check out repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: '0'
      - name: 📥 Setup Node and Install dependencies
        uses: ./.github/actions/setup
      - name: 🏷️ Tag version
        run: |
          git config user.name "Joel Paucarima Franco"
          git config user.email "<>"
          lerna version --conventional-commits --yes
      - name: ✅ Check Package Version
        uses: PostHog/check-package-version@v2
        id: cpv
        with:
          path: packages/utils
      - name: 📦 Publish package to NPM
        if: steps.cpv.outputs.is-new-version == 'true'
        run: |
          cd packages/utils
          yarn run build
          cp package.json ./dist && cp README.md ./dist
          npm publish ./dist --access public
          echo "Package published successfully 🎉"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: 🔖 Release version
        id: release
        uses: phish108/release-check@1.0.11-main.3
        with:
          github-token: ${{ secrets.GH_TOKEN }}
